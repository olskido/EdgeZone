generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Token {
  id          String  @id @default(cuid())
  name        String
  ticker      String
  contract    String // Removed @unique to allow same address on different chains (rare but safer)
  chain       String  @default("solana")
  pairAddress String? @map("pair_address")
  dexId       String? @map("dex_id")
  logoUrl     String? @map("logo_url")

  // Cached metrics for efficient sorting
  price     Decimal @default(0) @db.Decimal(38, 18)
  liquidity Decimal @default(0) @db.Decimal(38, 18)
  volume24h Decimal @default(0) @map("volume_24h") @db.Decimal(38, 18)
  marketCap Decimal @default(0) @map("market_cap") @db.Decimal(38, 18)

  createdAt      DateTime  @default(now()) @map("created_at")
  firstSeenAt    DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt     DateTime  @default(now()) @map("last_seen_at")
  pairCreatedAt  DateTime? @map("pair_created_at")
  lastIngestedAt DateTime? @map("last_ingested_at")

  // Analytics fields for behavioral engine
  momentumScore    Int       @default(0) @map("momentum_score")
  convictionScore  Int       @default(0) @map("conviction_score")
  threatLevel      String    @default("LOW") @map("threat_level")
  smartWalletFlow  Boolean   @default(false) @map("smart_wallet_flow")
  clusterDetected  Boolean   @default(false) @map("cluster_detected")
  aiSummary        String?   @map("ai_summary") @db.Text
  aiSummaryUpdated DateTime? @map("ai_summary_updated")

  snapshots    MarketSnapshot[]
  walletEvents WalletEvent[]
  transactions WalletTransaction[]
  signal       Signal?

  @@unique([contract, chain], name: "contract_chain")
  @@index([ticker])
  @@index([marketCap])
  @@index([volume24h])
  @@index([createdAt])
  @@index([pairCreatedAt])
  @@index([lastSeenAt])
  @@index([chain, volume24h, lastSeenAt])
  @@index([momentumScore])
  @@map("tokens")
}

model MarketSnapshot {
  id             String   @id @default(cuid())
  tokenId        String   @map("token_id")
  price          Decimal  @db.Decimal(38, 18)
  liquidity      Decimal  @db.Decimal(38, 18)
  volume         Decimal  @db.Decimal(38, 18)
  marketCap      Decimal  @map("market_cap") @db.Decimal(38, 18)
  fdv            Decimal? @db.Decimal(38, 18)
  priceChange24h Decimal? @map("price_change_24h") @db.Decimal(10, 2)
  timestamp      DateTime @default(now())

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([tokenId])
  @@index([timestamp])
  @@map("market_snapshots")
}

model WalletEvent {
  id        String   @id @default(cuid())
  tokenId   String   @map("token_id")
  wallet    String
  action    String
  amount    Decimal  @db.Decimal(38, 18)
  usdValue  Decimal  @map("usd_value") @db.Decimal(38, 18)
  label     String?
  timestamp DateTime @default(now())

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([tokenId])
  @@index([wallet])
  @@index([timestamp])
  @@map("wallet_events")
}

model Signal {
  tokenId         String   @id @map("token_id")
  convictionScore Int      @map("conviction_score")
  smartMoneyScore Int      @default(0) @map("smart_money_score")
  whaleScore      Int      @default(0) @map("whale_score")
  edgeScore       Int      @default(0) @map("edge_score")
  momentumPhase   String   @map("momentum_phase")
  threatLevel     String   @map("threat_level")
  edgeVerdict     String   @map("edge_verdict")
  confidence      Int
  updatedAt       DateTime @updatedAt @map("updated_at")

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@map("signals")
}

model WalletTransaction {
  id            String   @id @default(cuid())
  tokenId       String   @map("token_id")
  walletAddress String   @map("wallet_address")
  amountUsd     Decimal  @map("amount_usd") @db.Decimal(38, 18)
  side          String // 'buy' or 'sell'
  timestamp     DateTime
  signature     String   @unique

  token Token @relation(fields: [tokenId], references: [id], onDelete: Cascade)

  @@index([walletAddress])
  @@index([tokenId])
  @@index([timestamp])
  @@index([tokenId, timestamp])
  @@map("wallet_transactions")
}

model SmartWallet {
  walletAddress    String   @id @map("wallet_address")
  smartScore       Int      @default(0) @map("smart_score")
  totalWins        Int      @default(0) @map("total_wins")
  totalTrades      Int      @default(0) @map("total_trades")
  avgEntryPosition Decimal  @default(0) @map("avg_entry_position") @db.Decimal(5, 2)
  lastActive       DateTime @map("last_active")

  @@index([smartScore])
  @@index([lastActive])
  @@map("smart_wallets")
}
